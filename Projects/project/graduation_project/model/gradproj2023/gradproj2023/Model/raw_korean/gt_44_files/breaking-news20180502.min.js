!function(a){var b=App.Log,c={};App.BreakingNews=function(a,b,c){var d={templateId:"breaking-news-alert",hostname:"",secure:!0,port:443,showFilters:[]};this.options=$.extend({},d,a),this.templateId=this.options.templateId,this.container=$('<div class="breaking-news-container" style="z-index: 9999000;" />'),$("body").append(this.container),window.localStorage&&localStorage.setItem("ns.authToken",b),this.connect(c)},App.BreakingNews.socketQuery={},App.BreakingNews.prototype.el=function(){return this.container},App.BreakingNews.prototype.storage={set:function(a,b){window.sessionStorage?sessionStorage.setItem(a,b):(window.breakingNews.storage=window.breakingNews.storage||{},window.breakingNews.storage[a]=b)},get:function(a){return window.sessionStorage?sessionStorage.getItem(a):(window.breakingNews.storage=window.breakingNews.storage||{},window.breakingNews.storage[a]||void 0)}},App.BreakingNews.prototype.canShow=function(a){var c=this.options.showFilters,d=!c.length||!0;return c.forEach(function(b){d=d&&b(a)}),b("Can"+(d?" ":"'t ")+"show"),d},App.BreakingNews.prototype.connect=function(c){b("connect successfully, subscribing"),this.socket=a.connect({path:"/ns/",hostname:this.options.hostname,secure:this.options.secure,port:this.options.port,authTokenName:"ns.authToken",query:App.BreakingNews.socketQuery||{}}),this.socket.on("error",function(a){App.Log("Socket error - "+a)}),this.socket.on("connect",function(){App.Log("CONNECTED"),this.subscribe("site-wide"),"function"==typeof c&&c.apply(this)}.bind(this))},App.BreakingNews.prototype.subscribe=function(a,c){var d=function(a,b){return function(b){if(App.Log("["+a+"] response: ",b),!this.wasShown(b)&&this.canShow(b)){this.add(b).show(b);var c=function(){this.container.trigger($.Event("breaking-news-hidden",{notification:b})),this.hide(b);var a=JSON.parse(this.storage.get("breaking-news-shown-notifications"))||[];$.isArray(a)||(a=[]),a.push(b),this.storage.set("breaking-news-shown-notifications",JSON.stringify(a))}.bind(this);this.container.find(".breaking-news").on("click",".breaking-news-headline",function(a){a.preventDefault(),c(),App.GoogleAnalytics.TrackCustomEvent("breakingnews","click",b.sectionCategory,b.articleId);var d=$(this).attr("href");setTimeout(function(){window.location.assign(d)},100)}).on("click","[data-breaking-news-close-btn]",function(){c(),App.GoogleAnalytics.TrackCustomEvent("breakingnews","close",b.sectionCategory,b.articleId)}.bind(this))}}.bind(b)}(a,this);this.socket.subscribe(a).watch(c||d),this.socket.on(a,function(a,e){b("Personal message received for this socket",a),(c||d)(a),e(null,"Success")}.bind(this))},App.BreakingNews.prototype.wasShown=function(a){var c=JSON.parse(this.storage.get("breaking-news-shown-notifications"))||[],d=!1;$.isArray(c)||(c=[]);for(var e=0,f=c.length;e<f;e++){var g=c[e];a.sectionId===g.sectionId&&a.headline===g.headline&&a.url===g.url&&(d=!0)}return b("Was"+(d?"":" not")+" shown"),d},App.BreakingNews.prototype.add=function(a){return this.container.html(tmpl(this.templateId,a)),this},App.BreakingNews.prototype.show=function(a){return this.container.find(".breaking-news").removeClass("off").addClass("on"),App.GoogleAnalytics.TrackCustomEvent("breakingnews","view",a.sectionCategory,a.articleId),this.emit("breaking-news-show"),this},App.BreakingNews.prototype.hide=function(){return this.container.find(".breaking-news").addClass("off").removeClass("on"),this},App.BreakingNews.prototype.remove=function(){return this.container.find(".breaking-news").remove(),this},App.BreakingNews.prototype.emit=function(a){var b=$.Event(a,{target:this});if(c.hasOwnProperty(a))for(var d in c[a])c[a][d](b)},App.BreakingNews.prototype.on=function(a,b){c.hasOwnProperty(a)||(c[a]=[]),c[a].push(b)}}(window.socketCluster);