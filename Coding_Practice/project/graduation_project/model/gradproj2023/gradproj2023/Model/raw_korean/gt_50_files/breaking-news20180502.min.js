!function(a,b){var c=b.Log,d={};b.BreakingNews=function(a,b,c){var d={templateId:"breaking-news-alert",hostname:"",secure:!0,port:443,showFilters:[]};this.options=$.extend({},d,a),this.templateId=this.options.templateId,this.container=$('<div class="breaking-news-container"/>'),$("body").append(this.container),window.localStorage&&localStorage.setItem("ns.authToken",b),this.connect(c)},b.BreakingNews.socketQuery={},b.BreakingNews.prototype.el=function(){return this.container},b.BreakingNews.prototype.storage={set:function(a,b){window.sessionStorage?sessionStorage.setItem(a,b):(window.breakingNews.storage=window.breakingNews.storage||{},window.breakingNews.storage[a]=b)},get:function(a){return window.sessionStorage?sessionStorage.getItem(a):(window.breakingNews.storage=window.breakingNews.storage||{},window.breakingNews.storage[a]||void 0)}},b.BreakingNews.prototype.canShow=function(a){var b=this.options.showFilters,d=!b.length||!0;return b.forEach(function(b){d=d&&b(a)}),c("Can"+(d?" ":"'t ")+"show"),d},b.BreakingNews.prototype.connect=function(d){c("connect successfully, subscribing"),this.socket=a.connect({path:"/ns/",hostname:this.options.hostname,secure:this.options.secure,port:this.options.port,authTokenName:"ns.authToken",query:b.BreakingNews.socketQuery||{}}),this.socket.on("error",function(a){b.Log("Socket error - "+a)}),this.socket.on("connect",function(){b.Log("CONNECTED"),this.subscribe("site-wide"),"function"==typeof d&&d.apply(this)}.bind(this))},b.BreakingNews.prototype.subscribe=function(a,d){var e=function(a,c){return function(c){if(b.Log("["+a+"] response: ",c),!this.wasShown(c)&&this.canShow(c)){this.add(c).show(c);var d=function(){this.container.trigger($.Event("breaking-news-hidden",{notification:c})),this.hide(c);var a=JSON.parse(this.storage.get("breaking-news-shown-notifications"))||[];$.isArray(a)||(a=[]),a.push(c),this.storage.set("breaking-news-shown-notifications",JSON.stringify(a))}.bind(this);this.container.find(".breaking-news").on("click",".breaking-news-headline",function(a){a.preventDefault(),d(),b.GoogleAnalytics.TrackCustomEvent("breakingnews","click",c.sectionCategory,c.articleId);var e=$(this).attr("href");setTimeout(function(){window.location.assign(e)},100)}).on("click","[data-breaking-news-close-btn]",function(){d(),b.GoogleAnalytics.TrackCustomEvent("breakingnews","close",c.sectionCategory,c.articleId)}.bind(this))}}.bind(c)}(a,this);this.socket.subscribe(a).watch(d||e),this.socket.on(a,function(a,b){c("Personal message received for this socket",a),(d||e)(a),b(null,"Success")}.bind(this))},b.BreakingNews.prototype.wasShown=function(a){var b=JSON.parse(this.storage.get("breaking-news-shown-notifications"))||[],d=!1;$.isArray(b)||(b=[]);for(var e=0,f=b.length;f>e;e++){var g=b[e];a.sectionId===g.sectionId&&a.headline===g.headline&&a.url===g.url&&(d=!0)}return c("Was"+(d?"":" not")+" shown"),d},b.BreakingNews.prototype.add=function(a){return this.container.html(tmpl(this.templateId,a)),this},b.BreakingNews.prototype.show=function(a){return this.container.find(".breaking-news").removeClass("off").addClass("on"),b.GoogleAnalytics.TrackCustomEvent("breakingnews","view",a.sectionCategory,a.articleId),this.emit("breaking-news-show"),this},b.BreakingNews.prototype.hide=function(){return this.container.find(".breaking-news").addClass("off").removeClass("on"),this},b.BreakingNews.prototype.remove=function(){return this.container.find(".breaking-news").remove(),this},b.BreakingNews.prototype.emit=function(a){var b=$.Event(a,{target:this});if(d.hasOwnProperty(a))for(var c in d[a])d[a][c](b)},b.BreakingNews.prototype.on=function(a,b){d.hasOwnProperty(a)||(d[a]=[]),d[a].push(b)}}(window.socketCluster,window.ExpressApp);